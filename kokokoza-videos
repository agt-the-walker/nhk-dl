#!/usr/bin/env ruby
# encoding: UTF-8

require 'mechanize'

##### Configuration

KOKOKOZA_URL = 'http://www.nhk.or.jp/kokokoza/library/index.html'

##### Classes

class Kokokoza < Mechanize
  def videos
    get(KOKOKOZA_URL).links_with(:href => %r{^tv/}).each do |link|
      handle_section(link)
    end
  end

private

  def handle_section(link)
    if OPT_DEBUG
      STDERR.puts "Section: #{link.uri}"
    end
    transact {
      section_name = link.text
      link.click
      handle_section_tab(section_name)

      page.links_with(:href => %r{^index\d+\.html}).each do |link|
        link.click
        handle_section_tab(section_name)
      end
    }
  end

  def handle_section_tab(section_name)
    if OPT_DEBUG
      STDERR.puts "Section tab: #{page.uri}"
    end
    page.links.each do |link|
      if link.href =~ %r{/chapter(\d+).html}
        handle_video(section_name, $1.to_i, link)
      end
    end
  end

  def handle_video(section_name, episode, link)
    if OPT_DEBUG
      STDERR.puts "Video page: #{link.uri}"
    end
    transact {
      # the following regexp comes from http://www.ruby-forum.com/topic/860528
      video_name = link.text.sub(/\A[[:space:]]*(.*?)[[:space:]]*\z/, '\1')
      link.click
      if video_link = page.link_with(:href => /\.asx$/)
        puts section_name, '%02d - %s' % [episode, video_name],
             video_link.href, ''
      end
    }
  end
end

##### Argument parsing

OPT_DEBUG = ARGV[0] == '--debug' && ARGV.shift
if ARGV.size > 0
  abort "Usage: #$0 [--debug]"
end

##### Main program

Kokokoza.new.videos
