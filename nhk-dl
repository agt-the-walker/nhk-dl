#!/usr/bin/env ruby1.9
# encoding: UTF-8

require 'escape'
require 'fileutils'

##### Configuration

VIDEO_EXTENSION='.wmv'

##### Argument parsing

DEST_DIR = ARGV[0]
if DEST_DIR.nil? or not File.directory?(DEST_DIR)
  STDERR.puts "Usage: #$0 <destination directory>"
  exit 1
end

##### Main program

saved_section, counter = nil, nil

STDIN.collect { |line| line.chomp }
     .chunk { |line| (not line.empty?) || nil }
     .each do |_, lines|
  section, video, url = lines
  streaming_url =
      url.sub(%r{^http://www}, 'mms://wm')
         .sub('/kokokoza/metafiles/', '/wm2/kokokoza-mov/streaming/')
         .sub(/\.asx$/, VIDEO_EXTENSION)

  if section != saved_section
    saved_section = section
    counter = 0
  end
  counter += 1

  dest_dir = File.join(DEST_DIR, section)
  dest_file = File.join(dest_dir,
                        '%02d - %s' % [counter, video + VIDEO_EXTENSION])
  unless File.exists?(dest_file)
    FileUtils.mkdir_p(dest_dir)
    cmd = ['mplayer', '-dumpstream', '-dumpfile',
           Escape.shell_single_word(dest_file),
           Escape.shell_single_word(streaming_url)].join(' ')
    if system("#{cmd} >/dev/null 2>&1") and File.size?(dest_file)
      puts "#{Time.now}: #{dest_file}"
    else
      STDERR.puts "#{Time.now}: #{dest_file} FAILED"
      exit 1
    end
  end
end
